<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>JESA - Registre Juridique</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --jesa-blue: #0056b3;
            --jesa-orange: #ff6b35;
            --jesa-green: #28a745; 
            --bg: #f7f8fa; 
            --surface: #ffffff; 
            --border: #e4e7eb;
            --border-hover: #d0d5dd;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --primary: var(--jesa-blue);
            --primary-light: #e6f0ff;
            --accent: var(--jesa-orange);
            --success: var(--jesa-green);
            --success-light: #eaf7ee;
            --shadow-sm: 0 1px 2px rgb(0 0 0 / 0.04);
            --shadow-md: 0 4px 8px -2px rgb(20 20 43 / 0.07), 0 2px 4px -2px rgb(20 20 43 / 0.04);
        }

        [data-theme="dark"] {
            --bg: #111827;
            --surface: #1f2937;
            --border: #374151;
            --border-hover: #4b5563;
            --text-primary: #f3f4f6;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --primary: #4d9eff; /* Lighter blue for dark mode contrast */
            --primary-light: rgba(77, 158, 255, 0.1);
            --accent: #ff8c66; /* Lighter orange */
            --success: #34d399;
            --success-light: rgba(52, 211, 153, 0.1);
            --jesa-blue: #4d9eff;
            --jesa-orange: #ff8c66;
            --jesa-green: #34d399;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg); color: var(--text-primary);
            line-height: 1.6; min-height: 100vh;
        }
        .header { background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1600px; margin: 0 auto; padding: 0 2rem; height: 64px; display: flex; align-items: center; justify-content: space-between; }
        .header-left, .header-right { display: flex; align-items: center; gap: 1rem; }
        .logo { height: 32px; object-fit: contain; }
        .app-title { font-weight: 600; font-size: 1.1rem; color: var(--text-primary); }
        .nav-link {
            padding: 0.5rem 1rem; border-radius: 0.5rem; color: var(--text-secondary);
            text-decoration: none; font-weight: 500; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;
            transition: all .2s ease;
        }
        .nav-link:hover { background: var(--bg); color: var(--text-primary); }
        .nav-link.active { color: var(--primary); background: var(--primary-light); }
        .icon-btn {
            width: 38px; height: 38px; border-radius: 0.5rem; border: none; background: transparent; color: var(--text-muted);
            display: grid; place-items: center; cursor: pointer; transition: all .2s ease;
        }
        .icon-btn:hover { background: var(--bg); color: var(--text-primary); }

        /* Main Content */
        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        .main-title { text-align: center; color: var(--jesa-blue); margin-bottom: 2rem; font-weight: 700; font-size: 1.875rem; }

        /* Step Indicator */
        .step-indicator { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 2rem; }
        .step { display: flex; align-items: center; gap: 0.5rem; }
        .step-number { width: 30px; height: 30px; border-radius: 50%; background: var(--border); color: var(--text-primary); display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .step.active .step-number { background: var(--jesa-blue); color: white; }
        .step.completed .step-number { background: var(--jesa-green); color: white; }
        .step-label { font-size: 0.9rem; color: var(--text-muted); }
        .step.active .step-label { color: var(--text-primary); font-weight: 600; }

        /* Grid & Cards */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }
        .card { background: var(--surface); border-radius: 0.75rem; border: 1px solid var(--border); box-shadow: var(--shadow-sm); margin-bottom: 2rem; }
        .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 1.125rem; font-weight: 600; color: var(--jesa-blue); display: flex; align-items: center; gap: 0.75rem; }
        .card-badge { font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0.75rem; border-radius: 99px; background: var(--jesa-orange); color: white; }
        .card-body { padding: 1.5rem; }

        /* Forms (Using old IDs) */
        .label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); font-size: 0.9rem; }
        .input, .select, .textarea {
            width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem;
            background: var(--bg); border: 1px solid var(--border);
            color: var(--text-primary); font-size: 0.95rem; transition: all 0.2s ease;
        }
        .input:focus, .select:focus, .textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .textarea { min-height: 160px; resize: vertical; margin-bottom: 1rem; }
        .note { font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem; }
        .row { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .row > div { flex: 1; }

        /* Buttons (Using old classes and IDs) */
        .btn-group { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.75rem 1.25rem; border-radius: 0.5rem; font-weight: 600;
            font-size: 0.9rem; border: none; cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--jesa-blue); color: white; }
        .btn-secondary { background: var(--jesa-orange); color: white; }
        .btn-success { background: var(--jesa-green); color: white; }
        .btn-ghost { background: var(--surface); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: var(--shadow-md); }

        /* Progress Bar (Old structure, new style) */
        .progress-container { background-color: var(--border); border-radius: 50px; margin: 1rem 0; display: none; overflow: hidden; }
        .progress-bar { height: 10px; border-radius: 50px; background: var(--jesa-green); width: 0%; transition: width 0.35s ease; }

        /* Results & KPIs (Old structure, new style) */
        .hidden { display: none !important; }
        .kpi { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem; }
        .kpi .item { background: var(--bg); border: 1px solid var(--border); padding: 0.75rem 1rem; border-radius: 0.5rem; flex: 1; }
        .kpi .item h4 { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }
        .kpi .item p { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }
        .alert { padding: 1rem; border-radius: 0.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .alert.info { background: var(--primary-light); color: var(--jesa-blue); }
        .alert.success { background: var(--success-light); color: var(--jesa-green); }

        /* Table (Old structure, new style) */
        .table-wrap { border: 1px solid var(--border); border-radius: 0.5rem; overflow: auto; background: var(--surface); max-height: 420px; margin-top: 1.5rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); text-align: left; font-size: 0.9rem; }
        thead th { position: sticky; top: 0; background: var(--bg); z-index: 1; font-weight: 600; color: var(--text-secondary); }
        .results-table tr:hover { background: var(--bg); }

        /* Toast & Footer */
        .toast {
            position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.25rem;
            background: var(--surface); border: 1px solid var(--border); border-radius: 0.5rem; box-shadow: var(--shadow-lg);
            display: flex; align-items: center; gap: 1rem; min-width: 320px;
            transform: translateX(calc(100% + 2rem)); transition: transform 0.4s ease; z-index: 1000;
        }
        .toast.hidden { transform: translateX(calc(100% + 2rem)); }
        footer { margin-top: auto; padding: 2rem; border-top: 1px solid var(--border); text-align: center; color: var(--text-muted); font-size: 0.875rem; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="{% url 'home' %}" style="text-decoration: none; display:flex; align-items:center; gap:0.75rem;">
                    <img src="https://afrimag.net/wp-content/uploads/2022/03/JESA-Logo-2048x480.png" alt="JESA Logo" class="logo">
                    <span class="app-title">Portail EIE</span>
                </a>
            </div>
            <nav class="header-right">
                <a href="{% url 'home' %}" class="nav-link"><i class="fas fa-home"></i> Accueil</a>
                <a href="{%url 'dashboard'  %}" class="nav-link active"><i class="fas fa-gavel"></i> Registre Juridique</a>
                <a href="{%url 'commitment' %}" class="nav-link"><i class="fas fa-clipboard-check"></i> Engagements</a>
                <button class="icon-btn" id="theme-toggle" aria-label="Basculer le thème"><i class="fas fa-moon"></i></button>
            </nav>
        </div>
    </header>

    <div class="container">
        <h1 class="main-title">Automatisation du Registre Juridique</h1>
        <div class="step-indicator">
            <div class="step" id="step-1"><div class="step-number">1</div><div class="step-label">Scraping</div></div>
            <div class="step" id="step-2"><div class="step-number">2</div><div class="step-label">Traitement PDF</div></div>
            <div class="step" id="step-3"><div class="step-number">3</div><div class="step-label">Analyse</div></div>
            <div class="step" id="step-4"><div class="step-number">4</div><div class="step-label">Résultats</div></div>
        </div>

        <div class="grid">
            <!-- Left Column -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-spider"></i> Collecte de PDFs (Scraping)</h2>
                        <span class="card-badge">Étape 1</span>
                    </div>
                    <div class="card-body">
                        <form id="scrape-form" onsubmit="return false;">
                            <div class="row">
                                <div><label class="label" for="base-url">URL de départ</label><input id="base-url" name="base_url" class="input" type="url" placeholder="https://www.environnement.gov.ma/" /></div>
                                <div><label class="label" for="max-pages">Pages max</label><input id="max-pages" name="max_pages" class="input" type="number" min="1" step="1" value="10" /></div>
                            </div>
                            <div class="row">
                                <div><label class="label" for="download">Télécharger PDFs</label><select id="download" name="download" class="select"><option value="true" selected>Oui</option><option value="false">Non (juste lister)</option></select></div>
                            </div>
                            <div class="btn-group" style="margin-top:0.6rem;">
                                <button id="scrape-btn" class="btn btn-primary" type="button"><i class="fas fa-play"></i> Lancer le scraping</button>
                                <button id="check-status-btn" class="btn btn-ghost" type="button"><i class="fas fa-info-circle"></i> Vérifier statut</button>
                            </div>
                        </form>
                        <div class="progress-container" id="scrape-progress"><div class="progress-bar" id="scrape-progress-bar"></div></div>
                        <div id="scrape-results" class="hidden">
                            <div class="kpi">
                                <div class="item"><h4>PDFs trouvés</h4><p id="pdfs-found">0</p></div>
                                <div class="item"><h4>PDFs téléchargés</h4><p id="pdfs-downloaded">0</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-file-pdf"></i> Traitement & Indexation</h2>
                        <span class="card-badge">Étape 2</span>
                    </div>
                    <div class="card-body">
                        <p class="note">Parse tous les PDFs téléchargés et génère la base de connaissances.</p>
                        <div class="btn-group">
                            <button id="process-pdfs-btn" class="btn btn-primary" type="button"><i class="fas fa-cogs"></i> Traiter les PDFs</button>
                            <button id="download-kb-btn" class="btn btn-ghost" disabled><i class="fas fa-download"></i> Télécharger KB (JSON)</button>
                        </div>
                        <div class="progress-container" id="process-progress"><div class="progress-bar" id="process-progress-bar"></div></div>
                        <div id="process-results" class="hidden">
                            <div class="alert success"><i class="fas fa-check-circle"></i> Base de connaissances générée</div>
                            <div class="kpi">
                                <div class="item"><h4>Documents traités</h4><p id="docs-processed">0</p></div>
                                <div class="item"><h4>Taille KB</h4><p id="kb-size">0 KB</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-project-diagram"></i> Description du Projet & Analyse</h2>
                        <span class="card-badge">Étape 3</span>
                    </div>
                    <div class="card-body">
                        <label class="label">Décrivez le contexte du projet</label>
                        <textarea id="project-description" class="textarea" placeholder="Ex: Projet de centrale, localisation, principales activités..."></textarea>
                        <div class="btn-group" style="margin-top: 1rem;">
                            <button id="analyze-btn" class="btn btn-success" type="button"><i class="fas fa-microscope"></i> Indexer & Analyser</button>
                            <button id="clear-desc-btn" class="btn btn-ghost" type="button"><i class="fas fa-eraser"></i> Effacer</button>
                        </div>
                        <div class="progress-container" id="analysis-progress"><div class="progress-bar" id="analysis-progress-bar"></div></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-chart-line"></i> Résultats & Téléchargements</h2>
                        <span class="card-badge">Étape 4</span>
                    </div>
                    <div class="card-body">
                        <div id="no-results" class="alert info"><i class="fas fa-info-circle"></i> Aucune analyse effectuée.</div>
                        <div id="analysis-results" class="hidden">
                            <div class="alert success"><i class="fas fa-check-circle"></i> Analyse disponible</div>
                            <div class="btn-group" style="margin-top: 1rem;">
                                <button id="generate-pdf-btn" class="btn btn-primary" type="button" disabled><i class="fas fa-file-pdf"></i> Registre PDF</button>
                                <button id="download-json-btn" class="btn btn-ghost" type="button"><i class="fas fa-file-code"></i> JSON (raffiné)</button>
                                <button id="view-details-btn" class="btn btn-ghost" type="button"><i class="fas fa-eye"></i> Voir Détails</button>
                            </div>
                            <div id="results-preview" class="table-wrap hidden">
                                <table class="results-table">
                                    <thead id="results-head"></thead>
                                    <tbody id="results-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>© 2025 JESA — Développé par Benali Jawad & Nouar Amine</footer>

    <div class="toast hidden" id="toast"><div id="toast-msg"></div></div>

    <script>
        // =============== Utilities ===============
        function getCookie(name){
          let cookieValue = null;
          if(document.cookie && document.cookie !== ''){
            const cookies = document.cookie.split(';');
            for(let i=0;i<cookies.length;i++){
              const cookie = cookies[i].trim();
              if(cookie.substring(0, name.length + 1) === (name + '=')){
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }
    
        function showToast(msg, timeout=3000){
          const toast = document.getElementById('toast');
          if(!toast) { console.log('[toast]', msg); return; }
          const msgEl = document.getElementById('toast-msg');
          if(msgEl) msgEl.textContent = msg;
          toast.classList.remove('hidden');
          setTimeout(()=> toast.classList.add('hidden'), timeout);
        }
    
        function updateStep(stepNumber, status='active'){
          document.querySelectorAll('.step').forEach(step=>step.classList.remove('active','completed'));
          for(let i=1;i<stepNumber;i++){
            const st = document.getElementById(`step-${i}`);
            if(st) st.classList.add('completed');
          }
          const cur = document.getElementById(`step-${stepNumber}`);
          if(cur) cur.classList.add(status==='completed' ? 'completed' : 'active');
        }
    
        const themeToggleButton = document.getElementById('theme-toggle');
        function applySavedTheme() {
            const saved = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            if (themeToggleButton) {
                themeToggleButton.querySelector('i').className = saved === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        }
        if (themeToggleButton) {
            themeToggleButton.addEventListener('click', () => {
                const cur = document.documentElement.getAttribute('data-theme') || 'light';
                const nxt = cur === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', nxt);
                themeToggleButton.querySelector('i').className = nxt === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                localStorage.setItem('theme', nxt);
            });
        }
        applySavedTheme();

        // =============== STEP 1: Start Scrape (POST /bo_scrape/start/) ===============
        (function setupScrape(){
          const scrapeBtn = document.getElementById('scrape-btn');
          if(!scrapeBtn) return;
          scrapeBtn.addEventListener('click', async ()=>{
            updateStep(1, 'active');
            const baseUrl = document.getElementById('base-url')?.value || '';
            const maxPages = parseInt(document.getElementById('max-pages')?.value || 0) || null;
            const headless = (document.getElementById('headless')?.value === 'true');
            const download = (document.getElementById('download')?.value === 'true');
    
            const progressWrap = document.getElementById('scrape-progress');
            const progressBar  = document.getElementById('scrape-progress-bar');
            if(progressWrap) progressWrap.style.display = 'block';
            scrapeBtn.disabled = true;
            if(progressBar) progressBar.style.width = '10%';
    
            try{
              const payload = {
                base_url: baseUrl || undefined,
                max_pages: maxPages || undefined,
                download: !!download,
                headless: !!headless
              };
              const resp = await fetch('/bo_scrape/start/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify(payload)
              });
              if(progressBar) progressBar.style.width = '55%';
              const text = await resp.text();
              let data;
              try{ data = JSON.parse(text); }catch{ data = { error: 'Réponse non-JSON', raw: text }; }
              if(!resp.ok || data.error){ throw new Error(data.error || `Erreur serveur (${resp.status})`); }
    
              const found = data.pdf_links_count ?? data.found_count ?? data.found ?? (Array.isArray(data.files) ? data.files.length : null);
              const downloaded = data.pdf_texts_count ?? data.downloaded_count ?? data.downloaded ?? (Array.isArray(data.files_downloaded) ? data.files_downloaded.length : null);
    
              document.getElementById('pdfs-found').textContent = (found !== null ? found : '—');
              document.getElementById('pdfs-downloaded').textContent = (downloaded !== null ? downloaded : '—');
    
              document.getElementById('scrape-results').classList.remove('hidden');
              if(progressBar) progressBar.style.width = '100%';
              showToast('Scraping terminé ✅', 3000);
              updateStep(1, 'completed');
            }catch(err){
              console.error('start_scrape error', err);
              showToast('Erreur scraping: ' + err.message, 6000);
            }finally{
              if(progressWrap) setTimeout(() => { progressWrap.style.display = 'none'; }, 500);
              scrapeBtn.disabled = false;
            }
          });
        })();
    
        // =============== STEP 2: Parse all PDFs (POST /bo_parse/parse_dir/) ===============
        (function setupParseDir(){
          const procBtn = document.getElementById('process-pdfs-btn');
          if(!procBtn) return;
          procBtn.addEventListener('click', async ()=>{
            updateStep(2, 'active');
            const progressWrap = document.getElementById('process-progress');
            const progressBar  = document.getElementById('process-progress-bar');
            if(progressWrap) progressWrap.style.display = 'block';
            procBtn.disabled = true;
            if(progressBar) progressBar.style.width = '18%';
            try{
              const payload = { write_json: true, recursive: true };
              const resp = await fetch('/bo_parse/parse_dir/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify(payload)
              });
              if(!resp.ok){
                const txt = await resp.text();
                throw new Error(`Erreur parse_dir (${resp.status}): ${txt.slice(0,200)}`);
              }
              if(progressBar) progressBar.style.width = '60%';
              const data = await resp.json();
              const count = data.count ?? (Array.isArray(data.results) ? data.results.length : 0);
              const results = data.results ?? [];
    
              document.getElementById('docs-processed').textContent = count;
    
              const jsonStr = JSON.stringify(results, null, 2);
              const blob = new Blob([jsonStr], { type: 'application/json' });
              document.getElementById('kb-size').textContent = `${(blob.size / 1024).toFixed(2)} KB`;
    
              const downloadKbBtn = document.getElementById('download-kb-btn');
              if(downloadKbBtn){
                downloadKbBtn.disabled = false;
                downloadKbBtn.onclick = () => {
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url; a.download = 'legal_register_kb.json';
                  document.body.appendChild(a); a.click();
                  document.body.removeChild(a); URL.revokeObjectURL(url);
                };
              }
              document.getElementById('process-results').classList.remove('hidden');
              if(progressBar) progressBar.style.width = '100%';
              showToast('Parsing terminé ✅', 3000);
              updateStep(2, 'completed');
            }catch(err){
              console.error('parse_dir error', err);
              showToast('Erreur: ' + err.message, 6000);
            }finally{
              setTimeout(()=>{ if(progressWrap) progressWrap.style.display = 'none'; }, 600);
              procBtn.disabled = false;
            }
          });
        })();
    
        // =============== STATUS CHECK ===============
        (function setupStatus(){
          const btn = document.getElementById('check-status-btn');
          if(!btn) return;
          btn.addEventListener('click', async ()=>{
            try{
              const [pdfResp, jsonResp] = await Promise.all([
                fetch('/bo_parse/list_pdfs/'),
                fetch('/bo_parse/list_jsons/')
              ]);
              let pdfCount = 0, jsonCount = 0;
              if(pdfResp.ok){
                const d = await pdfResp.json();
                pdfCount = Array.isArray(d.files) ? d.files.length : 0;
              }
              if(jsonResp.ok){
                const d2 = await jsonResp.json();
                jsonCount = Array.isArray(d2.files) ? d2.files.length : 0;
              }
              showToast(`PDFs: ${pdfCount} | JSONs: ${jsonCount}`);
            }catch(err){
              console.error('status error', err);
              showToast('Erreur de connexion au serveur', 3000);
            }
          });
        })();
    
        // =============== STEP 3: Analyze ===============

        const PDF_HEADERS = [
            "Phase","Activity/Aspect","Impacts","Jurisdiction",
            "Type","Legal Requirement","Date","Description",
            "Task","Responsibility","Comments"
          ];

      document.getElementById('analyze-btn').addEventListener('click', async () => {
      const description = document.getElementById('project-description').value.trim();
      if (!description) {
        showToast("Please enter a project description before analyzing.");
        return;
      }

      const progressWrap = document.getElementById('analysis-progress');
      const progressBar  = document.getElementById('analysis-progress-bar');
      progressWrap.style.display = 'block';
      progressBar.style.width = '20%';

      try {
        const resp = await fetch("/llm/analyze/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken")
          },
          body: JSON.stringify({
            description,
            // Optional LLM: set to true if you want refinement (costs tokens)
            // use_gemini: true,
            // refine_strategy: "fill_missing",
          })
        });

        if (!resp.ok) {
          const errText = await resp.text();
          showToast(`Error: ${resp.status} - ${errText}`);
          return;
        }

        const data = await resp.json();
        // analyze endpoint now returns the strict array your PDF expects:
        // [{ category_title, rows: [[11 cells], ...] }, ...]
        const structured = Array.isArray(data) ? data : (data.table_structured || []);

        if (!Array.isArray(structured) || structured.length === 0) {
          showToast("No structured data returned.");
          return;
        }

        // Show result section (do not overwrite its inner HTML)
        document.getElementById("no-results").style.display = "none";
        const resultDiv = document.getElementById("analysis-results");
        resultDiv.classList.remove("hidden");

        // Enable actions
        const pdfBtn = document.getElementById('generate-pdf-btn');
        const dlJsonBtn = document.getElementById('download-json-btn');
        const viewBtn = document.getElementById('view-details-btn');
        if (pdfBtn) pdfBtn.disabled = false;
        if (dlJsonBtn) dlJsonBtn.disabled = false;
        if (viewBtn) viewBtn.disabled = false;

        // Prepare preview rendering on demand
        if (viewBtn) {
          viewBtn.onclick = () => {
            renderStructuredPreview(structured);
            document.getElementById('results-preview').classList.remove('hidden');
          };
        }

        // Allow JSON download of the structured data
        if (dlJsonBtn) {
          dlJsonBtn.onclick = () => {
            const blob = new Blob([JSON.stringify(structured, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'legal_register_structured.json';
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
          };
        }

        progressBar.style.width = '100%';
        showToast("Analysis complete!");
        updateStep(3, 'completed');
      } catch (err) {
        console.error(err);
        showToast("Unexpected error during analysis.");
      } finally {
        setTimeout(()=>{ progressWrap.style.display = 'none'; }, 400);
      }
    });


function renderStructuredPreview(structured) {
  // structured: [{ category_title, rows: [[11 cells], ...] }, ...]
  const preview = document.getElementById('results-preview');
  const thead = document.getElementById('results-head');
  const tbody = document.getElementById('results-body');

  if (!Array.isArray(structured) || structured.length === 0) {
    if (tbody) tbody.innerHTML = '<tr><td colspan="11">Aucune donnée</td></tr>';
    if (preview) preview.classList.remove('hidden');
    return;
  }

  // Build header (11 fixed columns exactly as in your PDF)
  if (thead) {
    thead.innerHTML = '';
    const trh = document.createElement('tr');
    PDF_HEADERS.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      trh.appendChild(th);
    });
    thead.appendChild(trh);
  }

  // Build body with category separators
  if (tbody) {
    tbody.innerHTML = '';
    structured.forEach(category => {
      const catTitle = category?.category_title || 'Uncategorized';
      const catRow = document.createElement('tr');
      const catCell = document.createElement('td');
      catCell.colSpan = PDF_HEADERS.length;
      catCell.textContent = catTitle;
      catCell.style.background = '#fdecea';
      catCell.style.fontWeight = '700';
      catCell.style.color = '#b91c1c';
      catRow.appendChild(catCell);
      tbody.appendChild(catRow);

      (category?.rows || []).forEach(rowArr => {
        const tr = document.createElement('tr');
        // rowArr must be 11 cells. If shorter, pad with "".
        const cells = Array.isArray(rowArr) ? rowArr.slice(0, 11) : [];
        while (cells.length < 11) cells.push("");
        cells.forEach((cell, idx) => {
          const td = document.createElement('td');
          td.textContent = cell == null ? '' : String(cell);
          // Make first column (Phase) bold like your PDF
          if (idx === 0) td.style.fontWeight = '600';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    });

    preview.classList.remove('hidden');
  }
}

        // =============== STEP 4: Download PDF ===============
        (function setupGeneratePdf(){
          const btn = document.getElementById('generate-pdf-btn');
          if(!btn) return;
          btn.addEventListener('click', async ()=>{
            updateStep(4, 'active');
            btn.disabled = true;
            showToast('Génération du PDF en cours...');
            try{
              const resp = await fetch('/llm/download_pdf/', { method: 'GET' });
              if(!resp.ok) throw new Error(`Erreur serveur ${resp.status}`);
              const blob = await resp.blob();
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url; a.download = 'legal_register.pdf';
              document.body.appendChild(a); a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
              showToast('PDF téléchargé ✅');
              updateStep(4, 'completed');
            }catch(err){
              console.error('download_pdf error', err);
              showToast('Erreur PDF: ' + err.message, 6000);
            }finally{
              btn.disabled = false;
            }
          });
        })();
        // // Clear description button
        document.getElementById('clear-desc-btn').addEventListener('click', () => {
            document.getElementById('project-description').value = '';
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateStep(1, 'active');
        });
    </script>
</body>
</html>