<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>JESA - Registre Juridique (Analyse & Base de Connaissances)</title>
    <style>
        :root {
            --jesa-blue: #0056b3;
            --jesa-orange: #ff6b35;
            --jesa-green: #28a745;
            --jesa-light: #f8f9fa;
            --jesa-dark: #343a40;
            --bg-color: #f5f7fa;
            --text-color: #343a40;
            --card-bg: white;
            --card-shadow: 0 10px 30px rgba(0, 86, 179, 0.1);
            --border-color: #e1e5ee;
            --document-bg: #f9f9f9;
            --header-border: rgba(0, 86, 179, 0.1);
            --footer-border: rgba(0, 86, 179, 0.1);
            --muted: #6c757d;
        }
        [data-theme="dark"] {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            --border-color: #333;
            --document-bg: #252525;
            --header-border: rgba(255, 255, 255, 0.1);
            --footer-border: rgba(255, 255, 255, 0.1);
            --jesa-blue: #4d9eff;
            --jesa-orange: #ff8c66;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; transition: background-color 0.3s ease, color 0.3s ease; }
        body { background: var(--bg-color); color: var(--text-color); line-height:1.6; min-height:100vh; }
        .container { max-width: 1500px; margin: 0 auto; padding: 2rem; }
        header { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding-bottom:1rem; border-bottom:1px solid var(--header-border); }
        .logo-container { display:flex; align-items:center; gap: 0.75rem; }
        .logo { height: 60px; }
        .project-title { font-size:1.1rem; color:var(--jesa-blue); font-weight:600; }
        .theme-toggle { background:none; border:none; color:var(--text-color); cursor:pointer; font-size:1.2rem; padding:0.5rem; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; }
        .theme-toggle:hover { background-color: rgba(0, 86, 179, 0.1); }
        [data-theme="dark"] .theme-toggle:hover { background-color: rgba(255,255,255,0.1); }
        .tooltip { position:relative; display:inline-block; }
        .tooltip .tooltiptext { visibility:hidden; width:260px; background-color:#555; color:#fff; text-align:center; border-radius:6px; padding:6px; position:absolute; z-index:1; bottom:125%; left:50%; margin-left:-130px; opacity:0; transition:opacity 0.3s; font-size:0.8rem; }
        .tooltip:hover .tooltiptext { visibility:visible; opacity:1; }
        .main-title { text-align:center; color:var(--jesa-blue); margin:1.75rem 0; font-weight:700; font-size:2rem; position:relative; }
        .main-title:after { content:""; display:block; width:120px; height:4px; background:var(--jesa-orange); margin:0.5rem auto 0; border-radius:2px; }
        .grid { display:grid; grid-template-columns: 1fr 1fr; gap:2rem; }
        @media (max-width: 1100px){ .grid { grid-template-columns: 1fr; } }
        .card { background:var(--card-bg); border-radius:12px; box-shadow:var(--card-shadow); padding:1.5rem; border:1px solid var(--border-color); margin-bottom: 1.5rem; }
        .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
        .card-title { color:var(--jesa-blue); font-size:1.2rem; display:flex; align-items:center; gap:0.6rem; }
        .card-badge { background-color: var(--jesa-orange); color:#fff; padding:0.25rem 0.6rem; border-radius:50px; font-size:0.8rem; font-weight:600; }
        .subtle { color: var(--muted); font-size:0.9rem; }
        .text-area, .input, .select { width:100%; padding:0.85rem; border:2px solid var(--border-color); border-radius:8px; background:var(--card-bg); color:var(--text-color); font-size:1rem; }
        .text-area { min-height: 160px; resize:vertical; }
        .text-area:focus, .input:focus, .select:focus { outline:none; border-color:var(--jesa-blue); box-shadow:0 0 0 3px rgba(0,86,179,0.15); }
        .row { display:flex; gap:1rem; margin-bottom: 1rem; }
        .row > div { flex:1; }
        .btn { display:inline-flex; align-items:center; gap:0.5rem; padding:0.75rem 1.4rem; border-radius:48px; font-weight:600; border:none; cursor:pointer; font-size:1rem; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background:var(--jesa-blue); color:#fff; }
        .btn-primary:hover:not(:disabled) { background:#004494; transform:translateY(-1px); }
        .btn-secondary { background:var(--jesa-orange); color:#fff; }
        .btn-secondary:hover:not(:disabled) { background:#e05a2b; transform:translateY(-1px); }
        .btn-success { background:var(--jesa-green); color:#fff; }
        .btn-success:hover:not(:disabled) { background:#218838; transform:translateY(-1px); }
        .btn-ghost { background:transparent; border:1px solid var(--border-color); color:var(--text-color); }
        .btn-ghost:hover:not(:disabled) { border-color: var(--jesa-blue); }
        .btn-group { display:flex; gap:0.75rem; flex-wrap:wrap; }
        .progress-container { background-color:#e9ecef; border-radius:50px; margin:1rem 0; display:none; overflow: hidden; }
        [data-theme="dark"] .progress-container { background:#333; }
        .progress-bar { height:10px; border-radius:50px; background:var(--jesa-green); width:0%; transition: width 0.35s ease; }
        .status-line { display:flex; justify-content:space-between; align-items:center; margin-top:0.25rem; font-size:0.9rem; }
        .table-wrap { border:1px solid var(--border-color); border-radius:8px; overflow:auto; background:var(--document-bg); max-height:420px; }
        table { width:100%; border-collapse:collapse; }
        th, td { padding:0.6rem 0.75rem; border-bottom:1px solid var(--border-color); text-align:left; font-size:0.95rem; }
        thead th { position:sticky; top:0; background:var(--card-bg); z-index:1; }
        .pill { display:inline-flex; align-items:center; gap:0.35rem; padding:0.15rem 0.55rem; border-radius:999px; font-size:0.8rem; border:1px solid var(--border-color); }
        .pill.green { background:rgba(40,167,69,0.08); color:var(--jesa-green); border-color:rgba(40,167,69,0.25); }
        .pill.blue { background:rgba(0,86,179,0.08); color:var(--jesa-blue); border-color:rgba(0,86,179,0.25); }
        .pill.orange { background:rgba(255,107,53,0.08); color:var(--jesa-orange); border-color:rgba(255,107,53,0.25); }
        .muted { color: var(--muted); }
        .divider { height:1px; background:var(--border-color); margin:1rem 0; }
        .note { font-size:0.9rem; color:var(--muted); }
        .hidden { display:none !important; }
        .upload-area { border:2px dashed var(--border-color); border-radius:8px; padding:1.5rem; text-align:center; cursor:pointer; transition: all 0.3s ease; position:relative; background:transparent; }
        .upload-area:hover { border-color:var(--jesa-blue); background-color:rgba(0,86,179,0.03); }
        [data-theme="dark"] .upload-area:hover { background:rgba(0,86,179,0.1); }
        .upload-area.active { border-color: var(--jesa-green); background-color: rgba(40,167,69,0.05); }
        .kpi { display:flex; gap:1rem; flex-wrap:wrap; margin-top:0.5rem; }
        .kpi .item { background:var(--document-bg); border:1px solid var(--border-color); padding:0.75rem 1rem; border-radius:8px; min-width:140px; }
        .kpi .item h4 { font-size:0.9rem; color: var(--muted); font-weight:600; }
        .kpi .item p { font-size:1.05rem; font-weight:700; color: var(--text-color); }
        .toast { position:fixed; right:20px; bottom:20px; background:var(--card-bg); border:1px solid var(--border-color); box-shadow:var(--card-shadow); border-radius:8px; padding:0.75rem 1rem; min-width:280px; display:flex; gap:0.6rem; align-items:center; z-index:9999; }
        .link { color: var(--jesa-blue); text-decoration: none; border-bottom:1px dashed var(--jesa-blue); }
        .link:hover { color:#004494; }
        footer { text-align:center; margin-top:2rem; color:#6c757d; font-size:0.9rem; padding-top:1.25rem; border-top:1px solid var(--footer-border); }
        [data-theme="dark"] footer { color:#aaa; }
        .caps { text-transform: uppercase; letter-spacing: .04em; font-size:.85rem; color: var(--muted); }
        .switch { display:inline-flex; align-items:center; gap:0.5rem; }
        .switch input { transform: scale(1.2); }
        .badge-dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
        .badge-dot.green { background: var(--jesa-green); }
        .badge-dot.orange { background: var(--jesa-orange); }
        .badge-dot.blue { background: var(--jesa-blue); }
        .label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-color); }
        .results-table { margin-top: 1rem; }
        .results-table th { background: var(--jesa-blue); color: white; font-weight: 600; }
        .results-table tr:hover { background: rgba(0,86,179,0.05); }
        [data-theme="dark"] .results-table tr:hover { background: rgba(255,255,255,0.05); }
        .alert { padding: 1rem; border-radius: 8px; margin: 1rem 0; }
        .alert.info { background: rgba(0,86,179,0.1); border: 1px solid rgba(0,86,179,0.3); color: var(--jesa-blue); }
        .alert.success { background: rgba(40,167,69,0.1); border: 1px solid rgba(40,167,69,0.3); color: var(--jesa-green); }
        .alert.error { background: rgba(220,53,69,0.1); border: 1px solid rgba(220,53,69,0.3); color: #dc3545; }
        .step-indicator { display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; }
        .step { display: flex; align-items: center; gap: 0.5rem; }
        .step-number { width: 30px; height: 30px; border-radius: 50%; background: var(--border-color); color: var(--text-color); display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .step.active .step-number { background: var(--jesa-blue); color: white; }
        .step.completed .step-number { background: var(--jesa-green); color: white; }
        .step-label { font-size: 0.9rem; color: var(--muted); }
        .step.active .step-label { color: var(--text-color); font-weight: 600; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo-container">
        <img src="https://afrimag.net/wp-content/uploads/2022/03/JESA-Logo-2048x480.png" alt="JESA Logo" class="logo">
        <div>
          <div class="project-title">Système d'Analyse — Registre Juridique</div>
          <div style="font-size:0.88rem; color:var(--muted)">Scraping légal → parsing PDF → base de connaissances</div>
        </div>
      </div>

      <button class="theme-toggle" id="theme-toggle" aria-label="Basculer le thème">
        <i class="fas fa-moon"></i>
      </button>
    </header>

    <h1 class="main-title">Registre Juridique — Collecte & Analyse Automatisée</h1>

    <div class="step-indicator">
      <div class="step" id="step-1"><div class="step-number">1</div><div class="step-label">Scraping</div></div>
      <div class="step" id="step-2"><div class="step-number">2</div><div class="step-label">Traitement PDF</div></div>
      <div class="step" id="step-3"><div class="step-number">3</div><div class="step-label">Index / Analyse</div></div>
      <div class="step" id="step-4"><div class="step-number">4</div><div class="step-label">Résultats</div></div>
    </div>

    <div class="grid">
      <!-- Left column: Scrape + Process -->
      <div>
        <!-- Scraping card -->
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-spider"></i> Collecte de PDFs (Scraping)</div>
            <span class="card-badge">Étape 1</span>
          </div>

          <p class="label">Paramètres du scraping</p>
          <form id="scrape-form" onsubmit="return false;">
            <div class="row">
              <div>
                <label class="label" for="base-url">URL de départ</label>
                <input id="base-url" name="base_url" class="input" type="url" placeholder="https://www.environnement.gov.ma/" />
              </div>
              <div>
                <label class="label" for="max-pages">Pages max</label>
                <input id="max-pages" name="max_pages" class="input" type="number" min="1" step="1" value="10" />
              </div>
            </div>

            <div class="row">
              <div>
                <label class="label" for="headless">Mode navigateur</label>
                <select id="headless" name="headless" class="select">
                  <option value="true" selected>Headless (sans UI)</option>
                  <option value="false">Avec UI (débogage)</option>
                </select>
              </div>
              <div>
                <label class="label" for="download">Télécharger PDFs</label>
                <select id="download" name="download" class="select">
                  <option value="true" selected>Oui</option>
                  <option value="false">Non (juste lister)</option>
                </select>
              </div>
            </div>

            <div class="btn-group" style="margin-top:0.6rem;">
              <button id="scrape-btn" class="btn btn-primary" type="button"><i class="fas fa-play"></i> Lancer le scraping</button>
              <button id="check-status-btn" class="btn btn-ghost" type="button"><i class="fas fa-info-circle"></i> Vérifier statut</button>
            </div>
          </form>

          <div class="progress-container" id="scrape-progress">
            <div class="progress-bar" id="scrape-progress-bar"></div>
          </div>

          <div id="scrape-results" class="hidden">
            <div style="height:12px;"></div>
            <h3 style="margin-bottom:0.45rem;">Résultats du scraping</h3>
            <div class="kpi">
              <div class="item">
                <h4>PDFs trouvés</h4>
                <p id="pdfs-found">0</p>
              </div>
              <div class="item">
                <h4>PDFs téléchargés</h4>
                <p id="pdfs-downloaded">0</p>
              </div>
              <div class="item">
                <h4>Dossier source</h4>
                <p id="outdir-path" class="muted">—</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Process PDFs card -->
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-file-pdf"></i> Traitement & Indexation (Parse)</div>
            <span class="card-badge">Étape 2</span>
          </div>

          <p class="label">Parse tous les PDFs téléchargés et écriture des JSON</p>
          <div class="btn-group">
            <button id="process-pdfs-btn" class="btn btn-primary" type="button"><i class="fas fa-cogs"></i> Traiter les PDFs</button>
            <button id="download-kb-btn" class="btn btn-ghost" disabled><i class="fas fa-download"></i> Télécharger KB (JSON)</button>
          </div>

          <div class="progress-container" id="process-progress">
            <div class="progress-bar" id="process-progress-bar"></div>
          </div>

          <div id="process-results" class="hidden">
            <div class="alert success"><i class="fas fa-check-circle"></i> Base de connaissances générée</div>
            <div class="kpi">
              <div class="item"><h4>Documents traités</h4><p id="docs-processed">0</p></div>
              <div class="item"><h4>Taille KB</h4><p id="kb-size">0 KB</p></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right column: Analysis + Results -->
      <div>
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-project-diagram"></i> Description du projet / Indexation</div>
            <span class="card-badge">Étape 3</span>
          </div>

          <p class="label">Décrivez le contexte (utilisé si vous voulez que l'indexation/LLM prenne en compte le projet)</p>
          <textarea id="project-description" class="text-area" placeholder="Ex: Projet de centrale, localisation, principales activités, contraintes..."></textarea>

          <!-- LLM options -->
          <div class="row" style="margin-top:0.75rem; align-items:flex-end;">
            <div>
              <label class="label">Options LLM</label>
              <div class="switch">
                <input type="checkbox" id="use-gemini" checked>
                <label for="use-gemini">Utiliser Gemini</label>
              </div>
              <div class="switch">
                <input type="checkbox" id="add-to-fewshot">
                <label for="add-to-fewshot">Ajouter à la mémoire few-shot</label>
              </div>
            </div>
            <div>
              <label class="label" for="refine-strategy">Stratégie de raffinage</label>
              <select id="refine-strategy" class="select">
                <option value="fill_missing" selected>fill_missing (défaut)</option>
                <option value="strict">strict</option>
                <option value="none">none</option>
              </select>
            </div>
            <div>
              <label class="label" for="api-key">Clé API Gemini (facultatif)</label>
              <input id="api-key" class="input" type="password" placeholder="ex: AIzaSy..." />
            </div>
          </div>

          <div style="margin-top:0.6rem;">
            <button id="analyze-btn" class="btn btn-success" type="button"><i class="fas fa-microscope"></i> Indexer & Analyser (LLM côté serveur)</button>
            <button id="clear-desc-btn" class="btn btn-ghost" type="button"><i class="fas fa-eraser"></i> Effacer</button>
          </div>

          <div class="progress-container" id="analysis-progress">
            <div class="progress-bar" id="analysis-progress-bar"></div>
          </div>

          <div style="display:flex; justify-content:space-between; margin-top:0.75rem;">
            <div class="pill" id="analysis-state-pill"><span class="badge-dot blue" style="background:var(--jesa-blue)"></span><span id="analysis-state" style="margin-left:6px;">Prêt</span></div>
            <div class="pill hidden" id="save-state-pill"><i class="fas fa-database"></i><span id="save-state">Non sauvegardé</span></div>
          </div>
        </div>

        <!-- Results & Téléchargements -->
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-chart-line"></i> Résultats & Téléchargements</div>
            <span class="card-badge">Étape 4</span>
          </div>

          <div id="no-results" class="alert info">
            <i class="fas fa-info-circle"></i> Aucune analyse LLM effectuée. Lancez l'analyse pour obtenir des résultats.
          </div>

          <div id="analysis-results" class="hidden">
            <div class="alert success"><i class="fas fa-check-circle"></i> Analyse disponible</div>

            <div class="btn-group" style="margin-bottom:0.6rem;">
              <button id="generate-pdf-btn" class="btn btn-primary" type="button" disabled>
                <i class="fas fa-print"></i> Télécharger Registre (PDF)
              </button>
              <button id="download-pdf-btn" class="btn btn-primary" type="button">
                <i class="fas fa-file-pdf"></i> Télécharger PDF (original)
              </button>
              <button id="download-json-btn" class="btn btn-ghost" type="button">
                <i class="fas fa-file-code"></i> Télécharger JSON (raffiné)
              </button>
              <button id="view-details-btn" class="btn btn-ghost" type="button">
                <i class="fas fa-eye"></i> Voir Détails
              </button>
            </div>

            <div class="progress-container" id="generate-progress" style="display:none; margin-bottom:0.6rem;">
              <div class="progress-bar" id="generate-progress-bar"></div>
            </div>

            <div id="results-preview" class="table-wrap hidden">
              <table class="results-table">
                <thead id="results-head"></thead>
                <tbody id="results-body"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>

    <footer style="text-align:center; margin-top:1.25rem; color:var(--muted);">
      © 2025 JESA - Développé par Benali Jawad & Nouar Amine
    </footer>
  </div>

  <div id="toast" class="toast hidden">
    <i class="fas fa-circle-info"></i>
    <div id="toast-msg">Message</div>
  </div>

  <script>
    // =============== Utilities ===============
    function getCookie(name){
      let cookieValue = null;
      if(document.cookie && document.cookie !== ''){
        const cookies = document.cookie.split(';');
        for(let i=0;i<cookies.length;i++){
          const cookie = cookies[i].trim();
          if(cookie.substring(0, name.length + 1) === (name + '=')){
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function showToast(msg, timeout=3000){
      const toast = document.getElementById('toast');
      if(!toast) { console.log('[toast]', msg); return; }
      const msgEl = document.getElementById('toast-msg');
      if(msgEl) msgEl.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(()=> toast.classList.add('hidden'), timeout);
    }

    function updateStep(stepNumber, status='active'){
      document.querySelectorAll('.step').forEach(step=>step.classList.remove('active','completed'));
      for(let i=1;i<stepNumber;i++){
        const st = document.getElementById(`step-${i}`);
        if(st) st.classList.add('completed');
      }
      const cur = document.getElementById(`step-${stepNumber}`);
      if(cur) cur.classList.add(status==='completed' ? 'completed' : 'active');
    }

    function prettyKB(bytes){ return `${(bytes/1024).toFixed(2)} KB`; }

    const themeToggle = document.getElementById('theme-toggle');
    function applySavedTheme(){
      const saved = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', saved);
      if(themeToggle){
        const icon = themeToggle.querySelector('i');
        if(icon) icon.className = saved==='dark' ? 'fas fa-sun' : 'fas fa-moon';
      }
    }
    if(themeToggle){
      themeToggle.addEventListener('click', ()=>{
        const cur = document.documentElement.getAttribute('data-theme')||'light';
        const nxt = cur==='light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', nxt);
        const icon = themeToggle.querySelector('i');
        if(icon) icon.className = nxt==='dark' ? 'fas fa-sun' : 'fas fa-moon';
        localStorage.setItem('theme', nxt);
      });
    }
    applySavedTheme();

    // =============== STEP 1: Start Scrape (POST /bo_scrape/start/) ===============
    (function setupScrape(){
      const scrapeBtn = document.getElementById('scrape-btn');
      if(!scrapeBtn) return;
      scrapeBtn.addEventListener('click', async ()=>{
        updateStep(1, 'active');
        const baseUrl = document.getElementById('base-url')?.value || '';
        const maxPages = parseInt(document.getElementById('max-pages')?.value || 0) || null;
        const headless = (document.getElementById('headless')?.value === 'true');
        const download = (document.getElementById('download')?.value === 'true');

        const progressWrap = document.getElementById('scrape-progress');
        const progressBar  = document.getElementById('scrape-progress-bar');
        if(progressWrap) progressWrap.style.display = 'block';
        scrapeBtn.disabled = true;
        if(progressBar) progressBar.style.width = '10%';

        try{
          const payload = {
            base_url: baseUrl || undefined,
            max_pages: maxPages || undefined,
            download: !!download,
            headless: !!headless
          };
          const resp = await fetch('/bo_scrape/start/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify(payload)
          });
          if(progressBar) progressBar.style.width = '55%';
          const text = await resp.text();
          let data;
          try{ data = JSON.parse(text); }catch{ data = { error: 'Réponse non-JSON', raw: text }; }
          if(!resp.ok || data.error){ throw new Error(data.error || `Erreur serveur (${resp.status})`); }

          const found = data.pdf_links_count ?? data.found_count ?? data.found ?? (Array.isArray(data.files) ? data.files.length : null);
          const downloaded = data.pdf_texts_count ?? data.downloaded_count ?? data.downloaded ?? (Array.isArray(data.files_downloaded) ? data.files_downloaded.length : null);

          document.getElementById('pdfs-found').textContent = (found !== null ? found : '—');
          document.getElementById('pdfs-downloaded').textContent = (downloaded !== null ? downloaded : (download ? '—' : 0));

          const outdir = data.output_dir || data.output_path || (data.outdir) || null;
          if(outdir) document.getElementById('outdir-path').textContent = outdir;

          document.getElementById('scrape-results').classList.remove('hidden');
          if(progressBar) progressBar.style.width = '100%';
          showToast('Scraping terminé ✅', 3000);
          updateStep(1, 'completed');
        }catch(err){
          console.error('start_scrape error', err);
          showToast('Erreur scraping: ' + err.message, 6000);
        }finally{
          if(progressWrap) progressWrap.style.display = 'none';
          scrapeBtn.disabled = false;
        }
      });
    })();

    // =============== STEP 2: Parse all PDFs (POST /bo_parse/parse_dir/) ===============
    (function setupParseDir(){
      const procBtn = document.getElementById('process-pdfs-btn');
      if(!procBtn) return;
      procBtn.addEventListener('click', async ()=>{
        updateStep(2, 'active');
        const progressWrap = document.getElementById('process-progress');
        const progressBar  = document.getElementById('process-progress-bar');
        if(progressWrap) progressWrap.style.display = 'block';
        procBtn.disabled = true;
        if(progressBar) progressBar.style.width = '18%';
        try{
          const payload = { write_json: true, recursive: true };
          const resp = await fetch('/bo_parse/parse_dir/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify(payload)
          });
          if(!resp.ok){
            const txt = await resp.text();
            throw new Error(`Erreur parse_dir (${resp.status}): ${txt.slice(0,200)}`);
          }
          if(progressBar) progressBar.style.width = '60%';
          const data = await resp.json();
          const count = data.count ?? (Array.isArray(data.results) ? data.results.length : 0);
          const results = data.results ?? [];

          document.getElementById('docs-processed').textContent = count;

          const jsonStr = JSON.stringify(results, null, 2);
          const blob = new Blob([jsonStr], { type: 'application/json' });
          document.getElementById('kb-size').textContent = prettyKB(blob.size);

          const downloadKbBtn = document.getElementById('download-kb-btn');
          if(downloadKbBtn){
            downloadKbBtn.disabled = false;
            downloadKbBtn.onclick = () => {
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url; a.download = 'legal_register_kb.json';
              document.body.appendChild(a); a.click();
              document.body.removeChild(a); URL.revokeObjectURL(url);
            };
          }
          document.getElementById('process-results').classList.remove('hidden');
          if(progressBar) progressBar.style.width = '100%';
          showToast('Parsing terminé ✅', 3000);
          updateStep(2, 'completed');
        }catch(err){
          console.error('parse_dir error', err);
          showToast('Erreur: ' + err.message, 6000);
        }finally{
          setTimeout(()=>{ if(progressWrap) progressWrap.style.display = 'none'; }, 600);
          procBtn.disabled = false;
        }
      });
    })();

    // =============== STATUS CHECK (GET /bo_parse/list_pdfs/ and /bo_parse/list_jsons/) ===============
    (function setupStatus(){
      const btn = document.getElementById('check-status-btn');
      if(!btn) return;
      btn.addEventListener('click', async ()=>{
        try{
          const [pdfResp, jsonResp] = await Promise.all([
            fetch('/bo_parse/list_pdfs/'),
            fetch('/bo_parse/list_jsons/')
          ]);
          let pdfCount = 0, jsonCount = 0;
          if(pdfResp.ok){
            const d = await pdfResp.json();
            pdfCount = Array.isArray(d.files) ? d.files.length : 0;
          }
          if(jsonResp.ok){
            const d2 = await jsonResp.json();
            jsonCount = Array.isArray(d2.files) ? d2.files.length : 0;
          }
          showToast(`PDFs: ${pdfCount} | JSONs: ${jsonCount}`);
        }catch(err){
          console.error('status error', err);
          showToast('Erreur de connexion au serveur', 3000);
        }
      });
    })();

    // =============== STEP 3: Analyze latest scraped PDF via LLM ===============
    (function setupAnalyzeLLMFromScrape(){
      const analyzeBtn = document.getElementById('analyze-btn');
      if(!analyzeBtn) return;

      analyzeBtn.addEventListener('click', async ()=>{
        updateStep(3, 'active');

        const progressWrap = document.getElementById('analysis-progress');
        const progressBar  = document.getElementById('analysis-progress-bar');
        const stateEl      = document.getElementById('analysis-state');
        const savePill     = document.getElementById('save-state-pill');
        const saveState    = document.getElementById('save-state');

        const useGemini = document.getElementById('use-gemini')?.checked ?? true;
        const apiKey = (document.getElementById('api-key')?.value || '').trim();
        const refineStrategy = document.getElementById('refine-strategy')?.value || 'fill_missing';
        const addToFewshot = document.getElementById('add-to-fewshot')?.checked ?? false;

        if(progressWrap) progressWrap.style.display = 'block';
        analyzeBtn.disabled = true;
        if(progressBar) progressBar.style.width = '12%';
        if(stateEl) stateEl.textContent = 'Recherche des PDFs...';

        try{
          // 1) List latest PDFs
          let listResp = await fetch('/bo_parse/list_pdfs/');
          let listData = listResp.ok ? await listResp.json() : { files: [] };
          let files = Array.isArray(listData.files) ? listData.files : [];

          // fallback: check scraper directory listing if needed
          if(!files.length){
            const resp2 = await fetch('/bo_scrape/list/?ext=.pdf');
            if(resp2.ok){
              const d2 = await resp2.json();
              files = Array.isArray(d2.files) ? d2.files : [];
            }
          }

          if(!files.length) throw new Error("Aucun PDF trouvé. Veuillez d'abord lancer le scraping (Étape 1).");

          if(progressBar) progressBar.style.width = '30%';

          // Already sorted desc by mtime in backend, but sort again to be safe
          const ordered = files.slice().sort((a,b) => (b.mtime || 0) - (a.mtime || 0));
          const chosen = ordered[0];
          const pdfName  = chosen.name;
          const pdfUrl   = `/bo_parse/pdf/${encodeURIComponent(pdfName)}/`;

          window._lastPdfUrl = pdfUrl;
          window._lastPdfName = pdfName;

          if(stateEl) stateEl.textContent = `Téléchargement du PDF: ${pdfName}...`;

          // 2) Fetch the PDF blob from server
          const pdfResp = await fetch(pdfUrl);
          if(!pdfResp.ok) throw new Error(`Impossible de récupérer le PDF (${pdfResp.status})`);
          const pdfBlob = await pdfResp.blob();

          if(progressBar) progressBar.style.width = '55%';
          if(stateEl) stateEl.textContent = 'Envoi au LLM (analyse)...';

          // 3) Send to /llm/analyze/ as multipart/form-data
          const fd = new FormData();
          const fileForLLM = new File([pdfBlob], pdfName, { type: 'application/pdf' });
          fd.append('file', fileForLLM);
          fd.append('use_gemini', useGemini ? 'true' : 'false');
          if(apiKey) fd.append('api_key', apiKey);
          fd.append('refine_strategy', refineStrategy);
          fd.append('add_to_fewshot', addToFewshot ? 'true' : 'false');

          // Optional: pass project context (ignored if backend doesn't use it)
          const context = document.getElementById('project-description')?.value || '';
          if(context) fd.append('context', context);

          const llmResp = await fetch('/llm/analyze/', {
            method: 'POST',
            body: fd,
            credentials: 'same-origin',
            headers: { 'X-CSRFToken': getCookie('csrftoken') || '' }
          });

          const text = await llmResp.text();
          let data;
          try { data = JSON.parse(text); } catch{ throw new Error(`Réponse non-JSON: ${text.slice(0,200)}`); }
          if(!llmResp.ok || data.error){ throw new Error(data.error || `Erreur serveur (${llmResp.status})`); }

          if(progressBar) progressBar.style.width = '85%';

          const refined = data.json || {};
          const rows = flattenRows(refined);

          // 4) Wire UI buttons and preview
          document.getElementById('no-results')?.classList.add('hidden');
          document.getElementById('analysis-results')?.classList.remove('hidden');

          const dlOriginalBtn = document.getElementById('download-pdf-btn');
          if(dlOriginalBtn) dlOriginalBtn.onclick = () => { window.location.href = pdfUrl; };

          const jsonBtn = document.getElementById('download-json-btn');
          if(jsonBtn){
            jsonBtn.onclick = () => {
              const blob = new Blob([JSON.stringify(refined, null, 2)], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url; a.download = 'legal_register_refined.json';
              document.body.appendChild(a); a.click();
              document.body.removeChild(a); URL.revokeObjectURL(url);
            };
          }

          const viewBtn = document.getElementById('view-details-btn');
          if(viewBtn){ viewBtn.onclick = () => displayResults(rows); }

          // Enable "Télécharger Registre (PDF)" – GET /llm/download_pdf/
          const genBtn = document.getElementById('generate-pdf-btn');
          if(genBtn){ genBtn.disabled = !(data.rows_count > 0); }

          const savePill = document.getElementById('save-state-pill');
          const saveState = document.getElementById('save-state');
          if(savePill) savePill.classList.remove('hidden');
          if(saveState) saveState.textContent = `PDF: ${pdfName} | Lignes: ${data.rows_count} | Gemini: ${data.used_gemini ? 'Oui' : 'Non'}`;

          if(progressBar) progressBar.style.width = '100%';
          if(stateEl) stateEl.textContent = 'Terminé';

          showToast('Analyse LLM terminée ✅');
          updateStep(3, 'completed');
          updateStep(4, 'active');
        }catch(err){
          console.error('LLM analyze error', err);
          showToast('Erreur analyse: ' + err.message, 6000);
          const stateEl = document.getElementById('analysis-state');
          if(stateEl) stateEl.textContent = 'Erreur';
        }finally{
          const progressWrap = document.getElementById('analysis-progress');
          setTimeout(()=>{ if(progressWrap) progressWrap.style.display = 'none'; }, 600);
          analyzeBtn.disabled = false;
        }
      });
    })();

    function flattenRows(json){
      const out = [];
      if(json && Array.isArray(json.categories)){
        for(const cat of json.categories){
          const title = cat?.title || '';
          const rows = Array.isArray(cat?.rows) ? cat.rows : [];
          for(const r of rows){
            const o = { category_title: title };
            if(r && typeof r === 'object'){
              Object.keys(r).forEach(k => o[k] = r[k]);
            }else{
              o.value = String(r);
            }
            out.push(o);
          }
        }
      }else if(Array.isArray(json)){
        for(const r of json){
          out.push(typeof r === 'object' ? r : { value: String(r) });
        }
      }else if(json && typeof json === 'object'){
        out.push(json);
      }
      return out;
    }

    function displayResults(results){
      const preview = document.getElementById('results-preview');
      const thead   = document.getElementById('results-head');
      const tbody   = document.getElementById('results-body');
      const rows = Array.isArray(results) ? results : [];
      if(!rows.length){
        if(thead) thead.innerHTML = '';
        if(tbody) tbody.innerHTML = '<tr><td colspan="100%">Aucun résultat</td></tr>';
        if(preview) preview.classList.remove('hidden');
        return;
      }
      const columns = Object.keys(rows[0] || {});
      if(thead) thead.innerHTML = '';
      if(tbody) tbody.innerHTML = '';
      const headRow = document.createElement('tr');
      columns.forEach(h => { const th = document.createElement('th'); th.textContent = h; headRow.appendChild(th); });
      thead.appendChild(headRow);
      rows.forEach(row => {
        const tr = document.createElement('tr');
        columns.forEach(col => {
          const td = document.createElement('td');
          const val = row[col];
          td.textContent = (val === null || val === undefined) ? '' : (typeof val === 'object' ? JSON.stringify(val) : String(val));
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      if(preview) preview.classList.remove('hidden');
    }

    (function setupClear(){
      const el = document.getElementById('clear-desc-btn');
      if(el) el.addEventListener('click', ()=>{
        const p = document.getElementById('project-description'); if(p) p.value='';
      });
    })();

    // =============== STEP 4: Download Legal Register PDF (GET /llm/download_pdf/) ===============
    (function setupGeneratePdf(){
      const btn = document.getElementById('generate-pdf-btn');
      if(!btn) return;
      btn.addEventListener('click', async ()=>{
        updateStep(4, 'active');
        btn.disabled = true;
        showToast('Génération du PDF en cours...');
        try{
          const resp = await fetch('/llm/download_pdf/', { method: 'GET' });
          if(!resp.ok) throw new Error(`Erreur serveur ${resp.status}`);
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'legal_register.pdf';
          document.body.appendChild(a); a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showToast('PDF téléchargé ✅');
          updateStep(4, 'completed');
        }catch(err){
          console.error('download_pdf error', err);
          showToast('Erreur PDF: ' + err.message, 6000);
        }finally{
          btn.disabled = false;
        }
      });
    })();

    document.addEventListener('DOMContentLoaded', ()=> updateStep(1, 'active'));
  </script>

</body>
</html>