<html lang="fr" data-theme="light"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JESA – Registre des Engagements</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    :root {
      --jesa-blue: #0056b3;
      --jesa-orange: #ff6b35;

      --bg: #f7f8fa;
      --surface: #ffffff;
      --border: #e4e7eb;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;

      --primary: var(--jesa-blue);
      --primary-light: #e6f0ff;
      --accent: var(--jesa-orange);
      --accent-light: #fff0e9;

      --success: #10b981;
      --success-light: #e7f8f3;
      --warning: #f59e0b;
      --warning-light: #fff8e1;

      --shadow-sm: 0 1px 2px rgb(0 0 0 / 0.04);
      --shadow-md: 0 4px 8px -2px rgb(20 20 43 / 0.07), 0 2px 4px -2px rgb(20 20 43 / 0.04);
      --shadow-lg: 0 12px 16px -4px rgb(20 20 43 / 0.08), 0 4px 6px -2px rgb(20 20 43 / 0.04);
    }
    [data-theme="dark"] {
      --bg: #111827;
      --surface: #1f2937;
      --border: #374151;
      --text-primary: #f3f4f6;
      --text-secondary: #d1d5db;
      --text-muted: #9ca3af;

      --primary: #4d9eff;
      --primary-light: rgba(77, 158, 255, 0.1);
      --accent: #ff8c66;
      --accent-light: rgba(255, 140, 102, 0.1);

      --success: #34d399;
      --success-light: rgba(52, 211, 153, 0.1);
      --warning: #fbbf24;
      --warning-light: rgba(251, 191, 36, 0.1);
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      display: flex; flex-direction: column;
    }

    /* Header */
    .header { background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
    .header-content { max-width: 1600px; margin: 0 auto; padding: 0 2rem; height: 64px; display: flex; align-items: center; justify-content: space-between; }
    .header-left, .header-right { display: flex; align-items: center; gap: 1rem; }
    .logo { height: 32px; object-fit: contain; }
    .app-title { font-weight: 600; font-size: 1.1rem; color: var(--text-primary); }
    .nav-link {
      padding: 0.5rem 1rem; border-radius: 0.5rem; color: var(--text-secondary);
      text-decoration: none; font-weight: 500; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;
      transition: all .2s ease;
    }
    .nav-link:hover { background: var(--bg); color: var(--text-primary); }
    .nav-link.active { color: var(--primary); background: var(--primary-light); }
    .icon-btn {
      width: 38px; height: 38px; border-radius: 0.5rem; border: none; background: transparent; color: var(--text-muted);
      display: grid; place-items: center; cursor: pointer; transition: all .2s ease;
    }
    .icon-btn:hover { background: var(--bg); color: var(--text-primary); }

    /* Main layout */
    .main { flex:1; max-width:1600px; margin:0 auto; padding:2rem; width:100%; }
    .page-header { margin-bottom: 1.5rem; }
    .page-title { font-size: 1.875rem; font-weight: 700; letter-spacing: -0.02em; }
    .page-sub { color: var(--text-secondary); font-size: 1.05rem; margin-top: .25rem; }

    /* Workflow */
    .workflow { display:flex; justify-content:space-between; align-items:center; position:relative; padding: 1.25rem 0; margin-bottom: 1.5rem; }
    .workflow::before { content:''; position:absolute; top: 1.4rem; left: 10%; right: 10%; height: 2px; background: var(--border); }
    .step { display:flex; flex-direction:column; align-items:center; gap:.5rem; z-index:1; text-align:center; }
    .step-icon { width: 36px; height:36px; border-radius: 50%; background: var(--surface); border:2px solid var(--border); display:grid; place-items:center; color: var(--text-muted); transition: .2s; }
    .step.active .step-icon { border-color: var(--primary); color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }
    .step.completed .step-icon { background: var(--success); border-color: var(--success); color: #fff; }
    .step-label { font-size: .9rem; color: var(--text-secondary); font-weight: 600; }

    /* Grid & Cards */
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; } }

    .card { background: var(--surface); border:1px solid var(--border); border-radius: .75rem; box-shadow: var(--shadow-sm); }
    .card-header { padding: 1rem 1.5rem; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    .card-title { font-size: 1.125rem; font-weight: 600; display:flex; align-items:center; gap:.6rem; }
    .card-title i { color: var(--primary); }
    .card-badge { padding:.25rem .65rem; border-radius: 999px; background: var(--primary-light); color: var(--primary); font-weight:700; font-size:.75rem; }
    .card-body { padding:1.5rem; }

    /* Forms */
    .form-row { display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width:640px) { .form-row { grid-template-columns: 1fr; } }
    .label { display:block; margin-bottom:.35rem; font-weight:600; color:var(--text-primary); font-size:.9rem; }
    .input, .select, .textarea {
      width:100%; padding:.7rem .9rem; border:1px solid var(--border); background:var(--bg);
      border-radius:.5rem; color:var(--text-primary); font-size:.95rem; transition:.2s;
    }
    .input:focus, .select:focus, .textarea:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px var(--primary-light); }
    .textarea { min-height: 120px; resize: vertical; }

    /* Buttons */
    .btn-group { display:flex; gap:.75rem; flex-wrap: wrap; }
    .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.7rem 1.2rem; border-radius:.5rem; font-weight:700; font-size:.9rem; border:none; cursor:pointer; transition:.2s; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn-primary { background: var(--primary); color:#fff; }
    .btn-primary:hover:not(:disabled) { background:#004494; transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-secondary { background: var(--surface); color: var(--text-secondary); border:1px solid var(--border); }
    .btn-secondary:hover { background: var(--bg); border-color: var(--border); }
    .btn-success { background: var(--success); color:#fff; }
    .btn-success:hover { background:#0f9b6c; transform: translateY(-1px); box-shadow: var(--shadow-md); }

    /* Progress */
    .progress-wrapper { margin: 1rem 0 0; display:none; }
    .progress-label { display:flex; justify-content:space-between; color: var(--text-secondary); font-size:.85rem; margin-bottom:.4rem; }
    .progress-bar { height:8px; background: var(--border); border-radius:999px; overflow:hidden; }
    .progress-fill { height:100%; width:0%; background: var(--primary); border-radius:999px; transition: width .35s ease; }

    /* KPIs / Stats */
    .stats { display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .stat { padding: 1rem; background: var(--bg); border:1px solid var(--border); border-radius:.5rem; text-align:center; }
    .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--primary); }
    .stat-label { font-size:.85rem; color: var(--text-muted); }

    /* Alerts */
    .alert { padding: 1rem; border:1px solid transparent; border-radius:.5rem; display:flex; gap:.6rem; align-items:flex-start; margin-top: 1rem; }
    .alert.info { background: var(--primary-light); border-color: rgba(0,86,179,.2); color: var(--primary); }
    .alert.success { background: var(--success-light); border-color: rgba(16,185,129,.2); color: var(--success); }

    /* Table preview */
    .table-wrap { border:1px solid var(--border); border-radius:.5rem; overflow:auto; background: var(--surface); margin-top: 1rem; max-height: 420px; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:.7rem .9rem; border-bottom:1px solid var(--border); text-align:left; font-size:.95rem; }
    thead th { position: sticky; top:0; background: var(--surface); z-index: 1; color: var(--text-secondary); font-weight: 600; }
    tbody tr:hover { background: var(--bg); }

    /* Toast */
    .toast {
      position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.25rem; background: var(--surface);
      border:1px solid var(--border); border-radius:.5rem; box-shadow: var(--shadow-lg);
      display:flex; gap:.75rem; align-items:center; min-width:320px; transform: translateX(calc(100% + 2rem));
      transition: transform .35s ease; z-index:1000;
    }
    .toast.show { transform: translateX(0); }
    .toast-icon { font-size: 1.2rem; }
    .toast-title { font-weight: 700; font-size: .9rem; }
    .toast-message { color: var(--text-secondary); font-size: .85rem; }

    /* Footer */
    footer { margin-top:auto; padding: 2rem; text-align:center; color: var(--text-muted); border-top:1px solid var(--border); font-size:.9rem; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="/" style="text-decoration:none; display:flex; align-items:center; gap:.75rem;">
          <img src="https://afrimag.net/wp-content/uploads/2022/03/JESA-Logo-2048x480.png" alt="JESA Logo" class="logo">
          <span class="app-title">Portail EIE</span>
        </a>
      </div>
      <nav class="header-right">
        <a class="nav-link" href="/"><i class="fas fa-home"></i> Accueil</a>
        <a class="nav-link" href="/legal-register/"><i class="fas fa-gavel"></i> Registre Juridique</a>
        <a class="nav-link active" href="/commitment/"><i class="fas fa-clipboard-check"></i> Engagements</a>
        <button class="icon-btn" id="theme-toggle" aria-label="Basculer le thème"><i class="fas fa-moon"></i></button>
      </nav>
    </div>
  </header>

  <main class="main">
    <div class="page-header">
      <h1 class="page-title">Registre des Engagements</h1>
      <p class="page-sub">Collecte des documents, extraction des engagements, analyse assistée par IA et export.</p>
    </div>

    <!-- Workflow -->
    <div class="workflow">
      <div class="step active" id="wf-1">
        <div class="step-icon"><i class="fas fa-spider"></i></div>
        <div class="step-label">Collecte</div>
      </div>
      <div class="step" id="wf-2">
        <div class="step-icon"><i class="fas fa-file-pdf"></i></div>
        <div class="step-label">Traitement</div>
      </div>
      <div class="step" id="wf-3">
        <div class="step-icon"><i class="fas fa-brain"></i></div>
        <div class="step-label">Analyse</div>
      </div>
      <div class="step" id="wf-4">
        <div class="step-icon"><i class="fas fa-file-export"></i></div>
        <div class="step-label">Résultats</div>
      </div>
    </div>

    <div class="grid">
      <!-- Left Column -->
      <div>
        <!-- Scraping -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-spider"></i> Web Scraping — Collecte de PDFs</h2>
            <span class="card-badge">Étape 1</span>
          </div>
          <div class="card-body">
            <form id="scrape-form" method="POST" action="/scrape/">
              <div class="form-row">
                <div>
                  <label class="label" for="sources-select">Sites � choisir</label>
                  <select id="sources-select" name="base_urls" class="select" multiple="" required=""><option value="https://www.sgg.gov.ma/BulletinOfficiel.aspx">BulletinOfficiel</option><option value="https://www.mpm.gov.ma">Département de la Pêche maritime</option><option value="https://justice.gov.ma">Ministère de la Justice</option><option value="https://environnement.gov.ma/fr">Ministère de la transition energétique et du développement durable</option><option value="https://www.agriculture.gov.ma">Ministère de l’Agriculture, de la Pêche maritime, du Développement rural et des Eaux et Forêts</option><option value="https://www.mhpv.gov.ma">Ministère de l’Aménagement du territoire national, de l’Urbanisme, de l’Habitat et de la Politique de la ville</option><option value="https://www.mcinet.gov.ma">Ministère de l’Industrie et du Commerce</option><option value="https://www.finances.gov.ma">Ministère de l’Économie et des Finances</option><option value="https://www.equipement.gov.ma">Ministère de l’Équipement et de l’Eau</option><option value="https://diplomatie.ma">Ministère des Affaires étrangères, de la Coopération africaine et des Marocains résidant à l’étranger</option></select>
                </div>
                <div>
                  <label class="label">&nbsp;</label>
                  <div class="btn-group">
                    <button type="submit" class="btn btn-primary" id="scrape-btn"><i class="fas fa-play"></i> Lancer</button>
                    <button type="button" class="btn btn-secondary" id="check-status-btn"><i class="fas fa-info-circle"></i> Statut</button>
                  </div>
                </div>
              </div>
              <input type="hidden" name="csrfmiddlewaretoken" value="&lt;input type=" hidden"="">"&gt;
            </form>

            <div class="progress-wrapper" id="scrape-progress">
              <div class="progress-label"><span>Collecte en cours...</span><span id="scrape-percent">0%</span></div>
              <div class="progress-bar"><div class="progress-fill" id="scrape-progress-fill"></div></div>
            </div>

            <div id="scrape-results" style="display:none;">
              <div class="stats">
                <div class="stat"><div class="stat-value" id="pdfs-found">0</div><div class="stat-label">PDFs trouvés</div></div>
                <div class="stat"><div class="stat-value" id="pdfs-downloaded">0</div><div class="stat-label">PDFs téléchargés</div></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Processing -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-file-pdf"></i> Traitement des PDFs</h2>
            <span class="card-badge">Étape 2</span>
          </div>
          <div class="card-body">
            <p class="page-sub" style="margin-bottom:1rem;">Extraction du contenu et création de la base de connaissances.</p>
            <div class="btn-group">
              <button class="btn btn-primary" id="process-pdfs-btn"><i class="fas fa-microchip"></i> Traiter</button>
              <button class="btn btn-secondary" id="download-kb-btn" disabled=""><i class="fas fa-download"></i> Télécharger KB (JSON)</button>
            </div>

            <div class="progress-wrapper" id="process-progress">
              <div class="progress-label"><span>Traitement...</span><span id="process-percent">0%</span></div>
              <div class="progress-bar"><div class="progress-fill" id="process-progress-fill"></div></div>
            </div>

            <div id="process-results" style="display:none;">
              <div class="alert success"><i class="fas fa-check-circle"></i> Base de connaissances générée</div>
              <div class="stats">
                <div class="stat"><div class="stat-value" id="docs-processed">0</div><div class="stat-label">Documents traités</div></div>
                <div class="stat"><div class="stat-value" id="kb-size">0 KB</div><div class="stat-label">Taille de la base</div></div>
              </div>
            </div>
          </div>
        </div>
        <!-- Existing Commitment Registers (DB / Upload) -->
<div class="card">
  <div class="card-header" style="border-bottom:none; padding-bottom:.75rem;">
    <div style="display:flex;align-items:center;gap:.75rem;">
      <div style="width:36px;height:36px;border-radius:50%;display:grid;place-items:center;background:var(--primary-light);color:var(--primary);">
        <i class="fas fa-database"></i>
      </div>
      <div>
        <h2 class="card-title" style="margin:0;">Registres d'engagements (DB / Upload)</h2>
        <div style="color:var(--text-secondary);font-size:.9rem;margin-top:.15rem;">
          Chargez d’anciens registres (PDF/JSON) ou utilisez ceux déjà générés en base.
        </div>
      </div>
    </div>
    <span class="card-badge">Optionnel</span>
  </div>

  <div class="card-body" style="padding-top:.5rem;">
    <!-- From DB -->
    <div style="margin-bottom:1rem;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:.75rem;margin-bottom:.5rem;">
        <label class="label" style="margin:0;">Depuis la base</label>
        <button id="cr-refresh-db" class="btn btn-secondary" type="button">
          <i class="fas fa-rotate"></i> Rafraîchir
        </button>
      </div>
      <div class="table-wrap" style="max-height:220px;">
        <table>
          <thead>
            <tr>
              <th style="width:45%;">Fichier</th>
              <th style="width:20%;">Taille</th>
              <th style="width:20%;">Ajouté</th>
              <th style="width:15%;">Actions</th>
            </tr>
          </thead>
          <tbody id="cr-db-tbody"></tbody>
        </table>
      </div>
      <div class="page-sub" id="cr-db-status" style="margin-top:.5rem;">—</div>
    </div>

    <hr style="border:none;border-top:1px solid var(--border);margin:1rem 0;" />

    <!-- Upload -->
    <div>
      <label class="label" for="cr-files">Téléverser (PDF ou JSON)</label>
      <input id="cr-files" class="input" type="file" accept=".pdf,.json" multiple />
      <div class="btn-group" style="margin-top:.75rem;">
        <button id="cr-upload-btn" class="btn btn-primary" type="button">
          <i class="fas fa-upload"></i> Uploader & Parser
        </button>
      </div>
      <div class="progress-wrapper" id="cr-upload-progress" style="display:none; margin-top:.75rem;">
        <div class="progress-label">
          <span id="cr-upload-status">Upload…</span>
          <span id="cr-upload-percent">0%</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="cr-upload-fill"></div></div>
      </div>
    </div>
  </div>
</div>

      </div>
      

      <!-- Right Column -->
      <div>
        <!-- Analysis -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-brain"></i> Analyse des Engagements (IA)</h2>
            <span class="card-badge">Étape 3</span>
          </div>
          <div class="card-body">
            <label class="label" for="project-description">Contexte du projet</label>
            <textarea class="textarea" id="project-description" placeholder="Décrivez votre projet : secteur, localisation, activités, principaux impacts, etc."></textarea>
            <div class="btn-group" style="margin-top: .75rem;">
              <button class="btn btn-success" id="analyze-btn"><i class="fas fa-microscope"></i> Analyser</button>
              <button class="btn btn-secondary" id="clear-desc-btn"><i class="fas fa-eraser"></i> Effacer</button>
            </div>

            <div class="progress-wrapper" id="analysis-progress">
              <div class="progress-label"><span id="analysis-status">Analyse en préparation...</span><span id="analysis-percent">0%</span></div>
              <div class="progress-bar"><div class="progress-fill" id="analysis-progress-fill"></div></div>
            </div>
          </div>
        </div>

        <!-- Results -->
        <!-- Results -->
<div class="card">
  <div class="card-header">
    <h2 class="card-title"><i class="fas fa-file-export"></i> Résultats &amp; Export</h2>
    <span class="card-badge">Étape 4</span>
  </div>
  <div class="card-body">
    <div id="no-results" class="alert info">
      <i class="fas fa-info-circle"></i> Aucune analyse effectuée. Veuillez lancer l’analyse.
    </div>

    <div id="analysis-results" style="display:none;">
      <div class="alert success"><i class="fas fa-check-circle"></i> Analyse terminée — Résultats disponibles</div>

      <!-- New actions for editing & saving -->
      <div class="btn-group" style="margin-bottom:.75rem;">
        <button class="btn btn-secondary" id="edit-results-btn">
          <i class="fas fa-pen"></i> Éditer
        </button>
        <button class="btn btn-secondary" id="save-results-btn" disabled>
          <i class="fas fa-save"></i> Enregistrer
        </button>
        <button class="btn btn-success" id="save-pdf-results-btn" disabled>
          <i class="fas fa-file-export"></i> Enregistrer &amp; PDF
        </button>

        <!-- Existing buttons kept intact -->
        <button class="btn btn-primary" id="download-pdf-btn">
          <i class="fas fa-file-pdf"></i> Télécharger PDF
        </button>
        <button class="btn btn-secondary" id="view-details-btn">
          <i class="fas fa-eye"></i> Voir détails
        </button>
      </div>

      <div id="unsaved-note" class="page-sub" style="display:none;color:var(--warning);margin-bottom:.25rem;">
        <i class="fas fa-exclamation-triangle"></i> Modifications non enregistrées
      </div>

      <div id="results-preview" class="table-wrap" style="display:none;">
        <table>
          <thead id="results-head"></thead>
          <tbody id="results-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

      </div>
    </div>
  </main>

  <footer>© 2025 JESA — Développé par Benali Jawad &amp; Nouar Amine</footer>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="toast-icon" id="toast-icon"><i class="fas fa-info-circle"></i></div>
    <div>
      <div class="toast-title" id="toast-title">Notification</div>
      <div class="toast-message" id="toast-message">Message</div>
    </div>
  </div>

  <script>
    // Theme
    const themeToggle = document.getElementById('theme-toggle');
    const html = document.documentElement;
    function initTheme(){
      const saved = localStorage.getItem('theme') || 'light';
      html.setAttribute('data-theme', saved);
      themeToggle.querySelector('i').className = saved === 'da rk' ? 'fas fa-sun' : 'fas fa-moon';
    }
    themeToggle.addEventListener('click', ()=>{
      const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      themeToggle.querySelector('i').className = next === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    });
    initTheme();

    // Toast
    function showToast(title, message, type='info'){
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toast-icon');
      const icons = { info:'fa-info-circle', success:'fa-check-circle', error:'fa-times-circle' };
      icon.innerHTML = `<i class="fas ${icons[type]}"></i>`;
      document.getElementById('toast-title').textContent = title;
      document.getElementById('toast-message').textContent = message;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 4500);
    }

    // Workflow
    const steps = [document.getElementById('wf-1'), document.getElementById('wf-2'), document.getElementById('wf-3'), document.getElementById('wf-4')];
    function updateWorkflow(step){
      steps.forEach((el, i) => {
        el.classList.remove('active', 'completed');
        if(i < step-1) el.classList.add('completed');
        else if(i === step-1) el.classList.add('active');
      });
    }
    updateWorkflow(1);

    // Helpers
    function getCookie(name){
      let cookieValue = null;
      if(document.cookie && document.cookie !== ''){
        const cookies = document.cookie.split(';');
        for(let i=0;i<cookies.length;i++){
          const cookie = cookies[i].trim();
          if(cookie.substring(0, name.length + 1) === (name + '=')){
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    function setProgress(wrapperId, fillId, percentId, value){
      const wrap = document.getElementById(wrapperId);
      const fill = document.getElementById(fillId);
      const percent = document.getElementById(percentId);
      if(wrap) wrap.style.display = 'block';
      if(fill) fill.style.width = value + '%';
      if(percent) percent.textContent = value + '%';
    }
    function endProgress(wrapperId, fillId){
      const wrap = document.getElementById(wrapperId);
      const fill = document.getElementById(fillId);
      setTimeout(()=>{ if(wrap) wrap.style.display = 'none'; if(fill) fill.style.width = '0%'; }, 600);
    }

    // Load scraping sources into the multi-select
    (async function loadSources(){
      try {
        const resp = await fetch('/bo_scrape/sources/', { method: 'GET' });
        const data = await resp.json();
        const sel = document.getElementById('sources-select');
        if (!sel) return;
        sel.innerHTML = '';
        (data?.sources || []).forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.url; opt.textContent = s.name || s.url; sel.appendChild(opt);
        });
      } catch (e) {
        // leave empty; user can still paste URL if needed via dev tools
      }
    })();

    // Step 1: Scrape
    const scrapeForm = document.getElementById('scrape-form');
    scrapeForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      updateWorkflow(1);
      const btn = document.getElementById('scrape-btn');
      btn.disabled = true;
      setProgress('scrape-progress', 'scrape-progress-fill', 'scrape-percent', 12);
      try{
        const formData = new FormData(scrapeForm);
        const resp = await fetch('/scrape/', { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') }, body: formData });
        setProgress('scrape-progress', 'scrape-progress-fill', 'scrape-percent', 70);
        if(!resp.ok) throw new Error('Erreur lors du scraping');
        const data = await resp.json();

        document.getElementById('pdfs-found').textContent = data.pdf_links_count || 0;
        document.getElementById('pdfs-downloaded').textContent = data.pdf_texts_count || 0;
        document.getElementById('scrape-results').style.display = 'block';

        setProgress('scrape-progress', 'scrape-progress-fill', 'scrape-percent', 100);
        showToast('Collecte terminée', 'Les documents ont été récupérés avec succès', 'success');
        updateWorkflow(2);
      }catch(err){
        showToast('Erreur', err.message, 'error');
      }finally{
        btn.disabled = false;
        endProgress('scrape-progress', 'scrape-progress-fill');
      }
    });

    // Status
    document.getElementById('check-status-btn').addEventListener('click', async ()=>{
      try{
        const resp = await fetch('/status/');
        const data = await resp.json();
        showToast('Statut du système', `Statut: ${data.status} — App: ${data.app}`, 'info');
      }catch(err){
        showToast('Erreur', 'Impossible de récupérer le statut', 'error');
      }
    });

    // Step 2: Process PDFs
    document.getElementById('process-pdfs-btn').addEventListener('click', async ()=>{
      updateWorkflow(2);
      const btn = document.getElementById('process-pdfs-btn');
      const dlBtn = document.getElementById('download-kb-btn');
      btn.disabled = true;
      setProgress('process-progress', 'process-progress-fill', 'process-percent', 18);
      try{
        const resp = await fetch('/process_pdfs/', { method: 'GET' });
        if(!resp.ok) throw new Error('Aucun PDF à traiter ou erreur serveur');
        setProgress('process-progress', 'process-progress-fill', 'process-percent', 65);
        const data = await resp.json();

        // Build KB blob
        const jsonStr = JSON.stringify(data.kb || [], null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const sizeKB = (blob.size / 1024).toFixed(2);

        // Enable download
        dlBtn.disabled = false;
        dlBtn.onclick = ()=>{
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'engagements_kb.json';
          document.body.appendChild(a); a.click();
          document.body.removeChild(a); URL.revokeObjectURL(url);
        };

        document.getElementById('docs-processed').textContent = data.docs_processed || 0;
        document.getElementById('kb-size').textContent = `${sizeKB} KB`;
        document.getElementById('process-results').style.display = 'block';

        setProgress('process-progress', 'process-progress-fill', 'process-percent', 100);
        showToast('Traitement terminé', 'Base de connaissances générée', 'success');
        updateWorkflow(3);
      }catch(err){
        showToast('Erreur', err.message, 'error');
      }finally{
        btn.disabled = false;
        endProgress('process-progress', 'process-progress-fill');
      }
    });

    // Step 3: Analyze commitments
    document.getElementById('analyze-btn').addEventListener('click', async ()=>{
      const desc = (document.getElementById('project-description').value || '').trim();
      if(!desc){ showToast('Description requise', 'Veuillez décrire votre projet', 'info'); return; }

      updateWorkflow(3);
      const btn = document.getElementById('analyze-btn');
      btn.disabled = true;
      document.getElementById('analysis-status').textContent = 'Préparation de l’analyse...';
      setProgress('analysis-progress', 'analysis-progress-fill', 'analysis-percent', 20);
      try{
        const resp = await fetch('/analyze_commitments/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
          body: JSON.stringify({ project_description: desc })
        });
        setProgress('analysis-progress', 'analysis-progress-fill', 'analysis-percent', 70);
        if(!resp.ok){
          const err = await resp.json().catch(()=>({error:'Erreur lors de l’analyse'}));
          throw new Error(err.error || 'Erreur lors de l’analyse');
        }
        const data = await resp.json();

        document.getElementById('no-results').style.display = 'none';
        document.getElementById('analysis-results').style.display = 'block';

        document.getElementById('download-pdf-btn').onclick = ()=> { window.location.href = '/download_commitment_register/'; };
        document.getElementById('view-details-btn').onclick = ()=> displayResults(data.result);

        setProgress('analysis-progress', 'analysis-progress-fill', 'analysis-percent', 100);
        document.getElementById('analysis-status').textContent = 'Analyse terminée';
        showToast('Analyse terminée', 'Résultats prêts pour export', 'success');
        updateWorkflow(4);
      }catch(err){
        showToast('Erreur', err.message, 'error');
      }finally{
        btn.disabled = false;
        endProgress('analysis-progress', 'analysis-progress-fill');
      }
    });
      let __resultsData = [];
  let __resultsHeaders = [];
  let __resultsEditMode = false;
  let __resultsDirty = false;

  function displayResults(results){
    const preview = document.getElementById('results-preview');
    const thead = document.getElementById('results-head');
    const tbody = document.getElementById('results-body');
    const editBtn = document.getElementById('edit-results-btn');
    const saveBtn = document.getElementById('save-results-btn');
    const savePdfBtn = document.getElementById('save-pdf-results-btn');
    const unsaved = document.getElementById('unsaved-note');

    preview.style.display = 'block';
    __resultsDirty = false;
    unsaved.style.display = 'none';

    if(!Array.isArray(results) || !results.length){
      thead.innerHTML = '';
      tbody.innerHTML = '<tr><td>Aucun résultat</td></tr>';
      // Also make sure the PDF button still works as before
      document.getElementById('download-pdf-btn').onclick = ()=> { window.location.href = '/download_commitment_register/'; };
      return;
    }

    // Keep a copy to allow re-renders without losing edits
    __resultsData = results.slice();
    __resultsHeaders = Object.keys(results[0] || {});

    // Build head
    thead.innerHTML = '';
    const trh = document.createElement('tr');
    __resultsHeaders.forEach(h => { const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); });
    thead.appendChild(trh);

    // Build body
    tbody.innerHTML = '';
    __resultsData.forEach(row=>{
      const tr = document.createElement('tr');
      __resultsHeaders.forEach(h=>{
        const td = document.createElement('td');
        const val = row[h];
        td.textContent = val == null ? '' : (typeof val === 'object' ? JSON.stringify(val) : String(val));
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    // Wire editing buttons (once)
    if (editBtn && !editBtn.__wired){
      editBtn.__wired = true;
      editBtn.addEventListener('click', ()=> {
        setResultsEditMode(!__resultsEditMode);
      });
    }
    if (saveBtn && !saveBtn.__wired){
      saveBtn.__wired = true;
      saveBtn.addEventListener('click', async ()=> {
        try {
          const payload = collectResultsFromTable();
          await saveResultsToServer(payload);
          __resultsData = payload;
          __resultsDirty = false;
          document.getElementById('unsaved-note').style.display = 'none';
          showToast('Enregistré', 'Modifications sauvegardées', 'success');
        } catch(e){
          showToast('Erreur', e.message || 'Impossible d\'enregistrer', 'error');
        }
      });
    }
    if (savePdfBtn && !savePdfBtn.__wired){
      savePdfBtn.__wired = true;
      savePdfBtn.addEventListener('click', async ()=> { await saveAndDownloadPdf(); });
    }

    // Mark dirty on user edits
    tbody.oninput = ()=> {
      if (__resultsEditMode){
        __resultsDirty = true;
        unsaved.style.display = 'block';
      }
    };

    // Override PDF download: if in edit mode (or dirty), save first then download
    const pdfBtn = document.getElementById('download-pdf-btn');
    if (pdfBtn){
      pdfBtn.onclick = async ()=> {
        if (__resultsEditMode || __resultsDirty){
          await saveAndDownloadPdf();
        } else {
          window.location.href = '/download_commitment_register/';
        }
      };
    }
  }

  // ---- Helpers (append below displayResults) ----
  function setResultsEditMode(on){
    __resultsEditMode = !!on;
    const tbody = document.getElementById('results-body');
    if (!tbody) return;

    tbody.querySelectorAll('td').forEach(td=>{
      td.contentEditable = __resultsEditMode ? 'true' : 'false';
      td.style.outline = __resultsEditMode ? '1px dashed var(--border)' : '';
    });

    const editBtn = document.getElementById('edit-results-btn');
    const saveBtn = document.getElementById('save-results-btn');
    const savePdfBtn = document.getElementById('save-pdf-results-btn');

    if (editBtn) editBtn.innerHTML = __resultsEditMode ? '<i class="fas fa-lock"></i> Fin édition' : '<i class="fas fa-pen"></i> Éditer';
    if (saveBtn) saveBtn.disabled = !__resultsEditMode;
    if (savePdfBtn) savePdfBtn.disabled = !__resultsEditMode;
  }

  function collectResultsFromTable(){
    const tbody = document.getElementById('results-body');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const out = [];
    rows.forEach(tr=>{
      const obj = {};
      Array.from(tr.children).forEach((td,i)=>{
        const key = __resultsHeaders[i] || `col_${i}`;
        const raw = (td.textContent || '').trim();
        obj[key] = parseSmartCell(raw);
      });
      out.push(obj);
    });
    return out;
  }

  function parseSmartCell(s){
    if (s === '') return '';
    if (s === 'true') return true;
    if (s === 'false') return false;
    if (!isNaN(s) && s.trim() !== '') return Number(s);
    if ((s.startsWith('{') && s.endsWith('}')) || (s.startsWith('[') && s.endsWith(']'))){
      try { return JSON.parse(s); } catch {}
    }
    return s;
  }

  async function saveResultsToServer(payload){
    // Implement this endpoint in your Django view to persist edited results
    const resp = await fetch('/commitment/save_results/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
      body: JSON.stringify({ results: payload })
    });
    if (!resp.ok) throw new Error(await resp.text());
    // optional JSON return {ok:true}
    return resp.json().catch(()=> ({}));
  }

  async function saveAndDownloadPdf(){
    try{
      const payload = collectResultsFromTable();
      await saveResultsToServer(payload);
      __resultsData = payload;
      __resultsDirty = false;
      const unsaved = document.getElementById('unsaved-note');
      if (unsaved) unsaved.style.display = 'none';
      showToast('Enregistré', 'Modifications sauvegardées', 'success');
      // Use your existing PDF generator endpoint
      window.location.href = '/download_commitment_register/';
    }catch(e){
      showToast('Erreur', e.message || 'Échec de l’enregistrement', 'error');
    }
  }


    // Clear description
    document.getElementById('clear-desc-btn').addEventListener('click', ()=>{
      document.getElementById('project-description').value = '';
    });



    async function crLoadDb(){
    const tbody = document.getElementById('cr-db-tbody');
    const status = document.getElementById('cr-db-status');
    if (!tbody) return;
    tbody.innerHTML = '<tr><td colspan="4" class="muted">Chargement…</td></tr>';
    try{
      const data = await fetch('/bo_parse/list_db_docs/?doc_type=old_register', { method:'GET' }).then(r=>r.json());
      const docs = Array.isArray(data?.docs) ? data.docs : [];
      if (!docs.length){
        tbody.innerHTML = '<tr><td colspan="4" class="muted">Aucun registre en base.</td></tr>';
        status.textContent = 'Aucun registre trouvé.';
        return;
      }
      tbody.innerHTML = '';
      docs.forEach(d=>{
        const tr = document.createElement('tr');
        const size = d.size ? Math.round(d.size/1024) + ' KB' : '—';
        const when = (d.created_at || '—').toString().slice(0,19).replace('T',' ');
        tr.innerHTML = `
          <td>${d.filename || '—'}</td>
          <td>${size}</td>
          <td>${when}</td>
          <td>
            <div class="btn-group">
              <button class="btn btn-secondary" data-load-id="${d.id}"><i class="fas fa-folder-open"></i> Charger</button>
              <a class="btn btn-primary" href="${d.download_url}" target="_blank"><i class="fas fa-download"></i></a>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
      status.textContent = `Total: ${docs.length}`;
      // wire load buttons
      tbody.querySelectorAll('[data-load-id]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-load-id');
          try{
            const resp = await fetch(`/commitment/load/${id}/`, { method:'GET' });
            const data = await resp.json();
            if(!resp.ok) throw new Error(data?.error || 'Erreur de chargement');
            // show results using your existing renderer
            document.getElementById('no-results').style.display = 'none';
            document.getElementById('analysis-results').style.display = 'block';
            displayResults(data.result || []);
            // enable PDF button right away
            const pdfBtn = document.getElementById('download-pdf-btn');
            if (pdfBtn) pdfBtn.disabled = false;
            showToast('Registre chargé', 'Les données ont été chargées depuis la base', 'success');
          }catch(e){
            showToast('Erreur', e.message || 'Impossible de charger', 'error');
          }
        });
      });
    }catch(e){
      if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="muted">Erreur de connexion.</td></tr>';
      if (status) status.textContent = 'Erreur lors du chargement.';
    }
  }
  document.getElementById('cr-refresh-db')?.addEventListener('click', crLoadDb);
  crLoadDb(); // initial

  function _crSetProgress(pct){
    const f = document.getElementById('cr-upload-fill');
    const p = document.getElementById('cr-upload-percent');
    if (f) f.style.width = Math.max(0, Math.min(100, pct)) + '%';
    if (p) p.textContent = Math.round(Math.max(0, Math.min(100, pct))) + '%';
  }

  // ---- Commitment Registers: Upload/Parse ----
  document.getElementById('cr-upload-btn')?.addEventListener('click', async ()=>{
    const inp = document.getElementById('cr-files');
    const files = Array.from(inp?.files || []);
    if (!files.length){ showToast('Alerte', 'Sélectionnez au moins un PDF ou JSON', 'info'); return; }

    const wrap = document.getElementById('cr-upload-progress');
    const status = document.getElementById('cr-upload-status');
    wrap.style.display = 'block'; _crSetProgress(5); if (status) status.textContent = 'Upload…';

    try{
      const fd = new FormData();
      files.forEach(f=> fd.append('files', f, f.name));
      const resp = await fetch('/commitment/upload/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: fd
      });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data?.error || 'Upload/parse échoué');

      _crSetProgress(100); if (status) status.textContent = 'Terminé';
      // show parsed preview as normal results table
      if (Array.isArray(data.preview_rows) && data.preview_rows.length){
        document.getElementById('no-results').style.display = 'none';
        document.getElementById('analysis-results').style.display = 'block';
        displayResults(data.preview_rows);
        const pdfBtn = document.getElementById('download-pdf-btn');
        if (pdfBtn) pdfBtn.disabled = false;
        showToast('Import réussi', `Lignes parsées: ${data.rows_count || data.preview_rows.length}`, 'success');
      }else{
        showToast('Info', 'Fichiers importés, aucune ligne parsée.', 'info');
      }
    }catch(e){
      showToast('Erreur', e.message || 'Impossible de téléverser', 'error');
    }finally{
      setTimeout(()=>{ wrap.style.display = 'none'; _crSetProgress(0); }, 800);
    }
  });

  </script>


</body></html>